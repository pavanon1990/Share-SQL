insert into MIG_NC_TPYFILNC
select
  NC_GET_WKREFN(gps.GP_CORE_SYSTEM,gps.GP_POLNO) as WKREFN
  ,GPS.GP_POLNO as WKORGN 
  ,nc_tpyfilnc_policy_status(clnt_pol.relationship_type) as WKROLE
  ,'NC' as WKSRCS
  ,( select substr(polsts,1,2) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKPSTS ----5
  ,( select t.agcde2 from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKAGNT 
  ,case when gps.ModuleCode = 'TCLM' 
    then (select cltr.plncde from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and cltr.clm_no like ''||clmpym.clm_no||'%' and rownum = 1) 
    else (select pm.plncde from data_conso.polmstpf pm where pm.polnbr = gps.GP_POLNO ) 
   end as WKPLNC
  ,(select clp.clientid from data_conso.cclient_pol clp where clp.policynumber = gps.GP_POLNO and clp.relationship_type = 'OWNR' and rownum = 1 ) as WKCNUM 
  ,'P' as WKCTYP
  ,(select t.Idno from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKIDNO  ----- 10
  ,(select substr(t.ttlnme,0,9) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKTTLN 
  ,(select substr(t.INSFST,0,30) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKFSNM 
  ,'' as WKMDNM
  ,(select substr(t.INSLST,0,30) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKLSNM 
  ,CASE WHEN length(clnt_add.address1) > 30  THEN substr(clnt_add.address1,1,30) ELSE clnt_add.address1 END as WKADD1 --15
  ,CASE WHEN length(clnt_add.address2) > 30  THEN substr(clnt_add.address2,1,30) ELSE clnt_add.address2 END as WKADD2
  ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.sub_district ELSE '' END as WKADD3
  ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.district ELSE '' END as WKADD4
  ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.province ELSE '' END as WKPROV
  ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.postcode ELSE '' END as WKZIPC
  ,gps.GP_CORE_SYSTEM
  ,gps.ModuleCode
  ,'GPS'
from data_gps gps
left join data_conso.cclient_pol clnt_pol on gps.GP_POLNO = clnt_pol.POLICYNUMBER
left join data_conso.clientaddress clnt_add on clnt_pol.clientaddressid = clnt_add.clientaddressid
left join Data_tscm tscm on gps.GP_POLNO = tscm.aclk_account_number
     and gps.gp_chqno = tscm.chqe_ext_chq_number
     and gps.gp_amount = tscm.chqe_amount
     and gps.gp_paiddate = tscm.paiddate
left join (select clm_no,pay_ref_no from data_conso.claim_payment group by clm_no,pay_ref_no) clmpym on to_char(tscm.actr_transaction_event_id) = clmpym.pay_ref_no
where
gps.gp_core_system = 'TLM' 
and gps.modulecode is not null
and clnt_pol.relationship_type != 'LIF2'

union 

select 
  NC_GET_WKREFN(datagps.GP_CORE_SYSTEM,datagps.GP_POLNO) as WKREFN
  ,datagps.GP_POLNO as WKORGN 
  ,'ADD' as WKROLE
  ,'NC' as WKSRCS
  ,( select substr(polsts,1,2) from data_conso.polmstpf  t where POLNBR = datagps.GP_POLNO) as WKPSTS ----5
  ,( select t.agcde2 from data_conso.polmstpf  t where POLNBR = datagps.GP_POLNO) as WKAGNT 
  ,case when datagps.ModuleCode = 'TCLM' 
    then (select cltr.plncde from data_conso.claim_transaction cltr where cltr.pol_no = datagps.GP_POLNO and cltr.clm_no like ''||clmpym.clm_no||'%' and rownum = 1) 
    else (select pm.plncde from data_conso.polmstpf pm where pm.polnbr = datagps.GP_POLNO ) 
   end as WKPLNC
  ,(select clp.clientid from data_conso.cclient_pol clp where clp.policynumber = datagps.GP_POLNO and clp.relationship_type = 'OWNR' and rownum = 1 ) as WKCNUM --clp.relationship_type = 'OWNR'
  ,'P' as WKCTYP
  ,(select t.Idno from data_conso.polmstpf  t where POLNBR = datagps.GP_POLNO) as WKIDNO  ----- 10
  ,(select substr(t.ttlnme,0,9) from data_conso.polmstpf  t where POLNBR = datagps.GP_POLNO) as WKTTLN 
  ,(select substr(t.INSFST,0,30) from data_conso.polmstpf  t where POLNBR = datagps.GP_POLNO) as WKFSNM 
  ,'' as WKMDNM
  ,(select substr(t.INSLST,0,30) from data_conso.polmstpf  t where POLNBR = datagps.GP_POLNO) as WKLSNM 
  ,CASE WHEN length(clnt_add.address1) > 30  THEN substr(clnt_add.address1,1,30) ELSE clnt_add.address1 END as WKADD1 --15
  ,CASE WHEN length(clnt_add.address2) > 30  THEN substr(clnt_add.address2,1,30) ELSE clnt_add.address2 END as WKADD2
  ,clnt_add.sub_district as WKADD3
  ,clnt_add.district as WKADD4
  ,clnt_add.province as WKPROV
  ,clnt_add.postcode as WKZIPC
  ,datagps.GP_CORE_SYSTEM
  ,datagps.ModuleCode
  ,'GPS'
from data_gps datagps
INNER JOIN (
   select gps.GP_POLNO from data_gps gps --clnt_pol.relationship_type
    left join data_conso.cclient_pol clnt_pol on gps.GP_POLNO = clnt_pol.POLICYNUMBER
    where  gps.gp_core_system = 'TLM' and gps.modulecode is not null
    and clnt_pol.relationship_type is not null and clnt_pol.relationship_type != 'LIF2'
    and NOT EXISTS(
      select clnt_pol.policynumber,clnt_pol.relationship_type from data_gps gp
      left join data_conso.cclient_pol clnt on gp.GP_POLNO = clnt.POLICYNUMBER
      where  gp.gp_core_system = 'TLM'
      and gp.modulecode is not null
      and clnt.relationship_type = 'DESA'
      and gps.GP_POLNO = gp.gp_polno )
   group by gps.GP_POLNO
) tb on datagps.GP_POLNO = tb.GP_POLNO
left join data_conso.cclient_pol clnt_pol on datagps.GP_POLNO = clnt_pol.POLICYNUMBER and clnt_pol.relationship_type = 'OWNR'
left join data_conso.clientaddress clnt_add on clnt_pol.clientaddressid = clnt_add.clientaddressid
left join Data_tscm tscm on datagps.GP_POLNO = tscm.aclk_account_number
     and datagps.gp_chqno = tscm.chqe_ext_chq_number
     and datagps.gp_amount = tscm.chqe_amount
     and datagps.gp_paiddate = tscm.paiddate
left join (select clm_no,pay_ref_no from data_conso.claim_payment group by clm_no,pay_ref_no) clmpym on to_char(tscm.actr_transaction_event_id) = clmpym.pay_ref_no

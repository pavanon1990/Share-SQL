-- ADD DESA TO NONDESA

select a.WKREFN 
      , a.WKORGN
      , a.WKROLE
      , a.WKSRCS
      , a.WKPSTS
      , a.WKAGNT
      , a.WKPLNC
      , a.WKCNUM
      , a.WKCTYP
      , a.WKIDNO
      , a.WKTTLN
      , a.WKFSNM
      , a.WKMDNM
      , a.WKLSNM
       ,clnt_add.address1 as WKADD1 --15
  ,clnt_add.address2 as WKADD2
  ,clnt_add.sub_district as WKADD3
  ,clnt_add.district as WKADD4
  ,clnt_add.province as WKPROV
  ,clnt_add.postcode as WKZIPC
       from(
select distinct
  CASE 
    WHEN gps.gp_core_system = 'TLM' THEN 3||SUBSTR(gps.gp_polno,6 ,length(gps.gp_polno))
    ELSE
      CASE
         WHEN length(gps.gp_polno) = 8 THEN ''
         WHEN length(gps.gp_polno) = 9 THEN 2||SUBSTR(gps.gp_polno,2 ,length(gps.gp_polno))
      END
  END as WKREFN
  ,GPS.GP_POLNO as WKORGN 
  ,clnt_pol.relationship_type as WKROLE ------- 
  ,'NC' as WKSRCS
  ,'' as WKPSTS                                                                                                                             ------- 5
  ,( select t.agcde2 from data_conso.polmstpf  t where POLNBR = REPLACE(gps.gp_polno,'XXXXX','10000')) as WKAGNT ------- เอา Replace ออกด้วย
  ,( select t.PLNCDE from data_conso.polmstpf  t where POLNBR = REPLACE(gps.gp_polno,'XXXXX','10000')) as WKPLNC ------- เอา Replace ออกด้วย
  ,'DESA' as WKCNUM ------- select t.clientid,t.* from data_conso.cclient_pol t where t.POLICYNUMBER = '100001016717'
  ,'P' as WKCTYP
  ,(select t.Idno from data_conso.polmstpf  t where POLNBR = REPLACE(gps.gp_polno,'XXXXX','10000')) as WKIDNO  ------- เอา Replace ออกด้วย               ------- 10
  ,(select t.ttlnme from data_conso.polmstpf  t where POLNBR = REPLACE(gps.gp_polno,'XXXXX','10000')) as WKTTLN ------- เอา Replace ออกด้วย
  ,(select t.INSFST from data_conso.polmstpf  t where POLNBR = REPLACE(gps.gp_polno,'XXXXX','10000')) as WKFSNM ------- เอา Replace ออกด้วย
  ,'' as WKMDNM
  ,(select t.INSLST from data_conso.polmstpf  t where POLNBR = REPLACE(gps.gp_polno,'XXXXX','10000')) as WKLSNM ------- เอา Replace ออกด้วย
  ,(select clnt_pol.clientaddressid from data_conso.cclient_pol clnt_pol where clnt_pol.POLICYNUMBER = REPLACE(gps.gp_polno,'XXXXX','10000') and rownum = 1 ) as clientaddressid ------- เอา Replace ออกด้วย)
from gps_payment gps 

where gps.gp_core_system = 'TLM'
and gps.gp_paymth||gps.gp_sub_paymth||gps.gp_lastupd_sts not in ('CCP','CCW','DDP','DDW','MAS','MBS','MCS','MMW','MMS')
and not EXISTS(
    select * from gps_payment subgps
      left join data_conso.cclient_pol clnt_pol on clnt_pol.POLICYNUMBER = REPLACE(subgps.gp_polno,'XXXXX','10000') ------- เอา Replace ออกด้วย
      where subgps.gp_core_system = 'TLM'
      and subgps.gp_paymth||subgps.gp_sub_paymth||subgps.gp_lastupd_sts not in ('CCP','CCW','DDP','DDW','MAS','MBS','MCS','MMW','MMS')
      and clnt_pol.relationship_type = 'DESA' and gps.gp_polno = subgps.gp_polno
)
) a
left join data_conso.clientaddress clnt_add on a.clientaddressid = clnt_add.clientaddressid
--and gps.gp_polno = 'XXXXX1016717'
--and clnt_pol.relationship_type = 'LIFE'

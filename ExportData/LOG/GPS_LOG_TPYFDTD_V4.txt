insert into MIG_NC_LOG  -- MIG_NC_TPYFDTD
select 
 SYS_GUID(),UPPER('MIG_NC_TPYFDTD') as FILE_NAME,tb.GP_CORE_SYSTEM,tb.ModuleCode,GP_POLNO,GP_CUSTREFNO
,tb.WKPLNC_LOG
,'GPS'
from 
(
select
  gps.GP_CUSTREFNO,gps.GP_POLNO,gps.ModuleCode,gps.GP_CORE_SYSTEM
  ,CASE 
     WHEN gps.GP_POLNO is not null and gps.use_source is not null THEN
       CASE 
       WHEN (gps.GP_CORE_SYSTEM = 'TLM' and gps.ModuleCode = 'TCLM') THEN 
         CASE 
           WHEN (select cltr.plncde from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and cltr.clm_no like ''||clmpym.clm_no||'%' and rownum = 1) is null 
           THEN 'Data not found plncde in GP_CORE_SYSTEM = TLM Module = TCLM AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC
         END
       WHEN (gps.GP_CORE_SYSTEM = 'TLM' and gps.ModuleCode != 'TCLM') then CASE WHEN gps.plncde is null THEN 'Data not found plncde in GP_CORE_SYSTEM = TLM Module != TCLM AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC END
       WHEN gps.use_source in ('C','D','E','L') THEN
          CASE
            WHEN (gps.ModuleCode = 'TCLM' and gps.use_source in ('C', 'D', 'L', 'E') ) THEN  -- clam : as400,cl,csdm,tclm
              CASE 
                WHEN (select clm_type from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and clm_type = 'DEAD' and rownum = 1) is not null 
                  THEN CASE WHEN gps.plncde is null THEN 'Data not found plncde in Module != TCLM SOURCE=E DEAD AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC  END --DEAD
                ELSE  
                  CASE -- NOT DEAD
                    WHEN (select cltr.plncde from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and rownum = 1) is not null --if plncde not null
                      THEN CASE WHEN (select cltr.plncde from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and rownum = 1) is null 
                        THEN 'Data not found plncde in Module != TCLM SOURCE=E NOT DEAD AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC END -- let plncde
                      ELSE CASE WHEN (select cltr.clm_type from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and rownum = 1) is null
                        THEN 'Data not found clm_type in Module != TCLM SOURCE=E NOT DEAD AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC END -- else let clm_type
                  END
              END
            WHEN (gps.ModuleCode != 'TCLM' and gps.use_source = 'E')  -- AS400 POST
              THEN 
                CASE 
                  WHEN (select plncde from as400bnh where as400bnh.polnbr = gps.GP_POLNO and as400bnh.chqnbr = gps.GP_CHQNO and as400bnh.bonval = gps.GP_AMOUNT) is null
                    THEN 'Data not found plncde in Module != TCLM SOURCE=E AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC 
                END
            WHEN (gps.ModuleCode != 'TCLM'  and gps.use_source = 'C' ) THEN  -- CS POST
              CASE 
                WHEN (select to_char(w.pos_eff-5430000) from mig_bank_info u left join cs_poltrack w on w.pol_no = u.upd_polno where gps.GP_POLNO = w.pol_no and (paid_refd-5430000) = gps.GP_PAIDDATE and ref_no = gps.GP_CHQNO and bal_amt = gps.GP_AMOUNT) is not null 
                  THEN 
                    CASE WHEN gps.plncde is null 
                         THEN 'Data not found plncde in Module != TCLM SOURCE=C AMOUNT='||gps.GP_AMOUNT||' CHQNO='||gps.GP_CHQNO||' PAIDDATE='||gps.GP_PAIDDATE||' PAY_DESC='||gps.GP_PAYDESC 
                    END
              END
            WHEN gps.ModuleCode != 'TCLM' and gps.use_source in ('D','L') THEN '' -- Direct,CL POST
          END
       ELSE
          'INVALID SOURCE : ' || gps.use_source
       END
     ELSE
       null -- POLICY IS NULL LOG ALREADY IN PYWREF
  END as WKPLNC_LOG
from data_gps gps
left join Data_tscm tscm on gps.GP_POLNO = tscm.aclk_account_number
     and gps.gp_chqno = tscm.chqe_ext_chq_number
     and gps.gp_amount = tscm.chqe_amount
     and gps.gp_paiddate = tscm.paiddate
left join (select clm_no,pay_ref_no from data_conso.claim_payment group by clm_no,pay_ref_no) clmpym on to_char(tscm.actr_transaction_event_id) = clmpym.pay_ref_no
where
gps.modulecode is not null
) tb
where tb.WKPLNC_LOG is not null

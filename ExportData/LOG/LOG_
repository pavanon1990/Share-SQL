select
  NC_GET_WKREFN(gps.GP_CORE_SYSTEM,gps.GP_POLNO) as WKREFN
  ,GPS.GP_POLNO as WKORGN 
  ,clnt_add.address1
  ,clnt_add.address2
from data_gps gps
left join data_conso.cclient_pol clnt_pol on gps.GP_POLNO = clnt_pol.POLICYNUMBER
left join data_conso.clientaddress clnt_add on clnt_pol.clientaddressid = clnt_add.clientaddressid
left join Data_tscm tscm on gps.GP_POLNO = tscm.aclk_account_number
     and gps.gp_chqno = tscm.chqe_ext_chq_number
     and gps.gp_amount = tscm.chqe_amount
     and gps.gp_paiddate = tscm.paiddate
where
gps.gp_core_system = 'TLM' 
and gps.modulecode is not null
and clnt_pol.relationship_type != 'LIF2'
and (length(clnt_add.address1) > 30
or length(clnt_add.address2) > 30) --412

union 

select 
  NC_GET_WKREFN(datagps.GP_CORE_SYSTEM,datagps.GP_POLNO) as WKREFN
  ,datagps.GP_POLNO as WKORGN 
  ,clnt_add.address1
  ,clnt_add.address2
from data_gps datagps
INNER JOIN (
   select gps.GP_POLNO from data_gps gps --clnt_pol.relationship_type
    left join data_conso.cclient_pol clnt_pol on gps.GP_POLNO = clnt_pol.POLICYNUMBER
    where  gps.gp_core_system = 'TLM' and gps.modulecode is not null
    and clnt_pol.relationship_type is not null and clnt_pol.relationship_type != 'LIF2'
    and NOT EXISTS(
      select clnt_pol.policynumber,clnt_pol.relationship_type from data_gps gp
      left join data_conso.cclient_pol clnt on gp.GP_POLNO = clnt.POLICYNUMBER
      where  gp.gp_core_system = 'TLM'
      and gp.modulecode is not null
      and clnt.relationship_type = 'DESA'
      and gps.GP_POLNO = gp.gp_polno )
   group by gps.GP_POLNO
) tb on datagps.GP_POLNO = tb.GP_POLNO
left join data_conso.cclient_pol clnt_pol on datagps.GP_POLNO = clnt_pol.POLICYNUMBER and clnt_pol.relationship_type = 'OWNR'
left join data_conso.clientaddress clnt_add on clnt_pol.clientaddressid = clnt_add.clientaddressid
left join Data_tscm tscm on datagps.GP_POLNO = tscm.aclk_account_number
     and datagps.gp_chqno = tscm.chqe_ext_chq_number
     and datagps.gp_amount = tscm.chqe_amount
     and datagps.gp_paiddate = tscm.paiddate
where
(length(clnt_add.address1) > 30 or length(clnt_add.address2) > 30) --140

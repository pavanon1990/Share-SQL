INSERT INTO MIG_NC_INTERFACE --ROW 7993: ,TIME : 2.14.401
select
  CASE  
     WHEN gps.ModuleCode = 'TCLM' and (gps.GP_PAYEE_NAME like '%โรงพยาบาล%' or gps.GP_PAYEE_NAME like '%ร.พ.%')
        THEN substr(gps.GP_CUSTREFNO,2,15)
      ELSE
        CASE
          WHEN  il.polnbr is not null THEN 
            CASE
              WHEN (il.org_source) = 'T' THEN '3'||SUBSTR(gps.GP_POLNO,6,LENGTH(gps.GP_POLNO))
              ELSE il.polnbr
            END 
          ELSE
            CASE
             WHEN pm_pol.source = 'T' THEN '3'||SUBSTR(gps.GP_POLNO,6,LENGTH(gps.GP_POLNO))
             WHEN pm_pol.source = 'E' THEN CASE WHEN length(gps.GP_POLNO) = 8 THEN gps.GP_POLNO ELSE lpad(gps.GP_POLNO,8,'0') END 
             WHEN pm_pol.source = 'C' THEN '2'||SUBSTR(gps.GP_POLNO,1,2)
             WHEN pm_pol.source = 'D' THEN (SELECT  PREFIX||SUBSTR(gps.GP_POLNO,11,5) from mig_dm_pol_no_prefix where DM_INDEX = SUBSTR(gps.GP_POLNO,1,9))
             WHEN pm_pol.source = 'L' THEN 
               CASE 
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)) = 0 THEN (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)) = 0 THEN (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)
                  ELSE 
                    gps.GP_POLNO -- LOG Data dupilcate from data_il.il_t_policy_mig
               END
             ELSE
               gps.GP_POLNO --INVALID SOURCE 
          END
      END
   END as WKREFN
  ,gps.gp_payee_name as PYWBEN
  ,gps.gp_confirmdate as PYWTRD 
  ,gps.gp_paiddate as PYWPYD
  ,gps.gp_amount as PYWAMT--5
  ,gps.gp_paydesc as PYWCM1
  ,'' as PYWCM2       
  ,ModuleCode as PYWMOD
  ,gps.PYWPYT
  ,NC_GET_BANK_ACC_CHQE(gps.GP_PAYMTH,gps.GP_BNKCODE,null,null,'PYWBNK') as PYWBNK --10
  ,NC_GET_BANK_ACC_CHQE(gps.GP_PAYMTH,null,gps.GP_PAYEE_BNKACCNO,null,'PYWACT') as PYWACT 
  ,gps.PYWTYP
  ,NC_GET_BANK_ACC_CHQE(gps.GP_PAYMTH,null,null,gps.GP_CHQNO,'PYWCHQ') as PYWCHQ
  ,gps.PYWCHS
  ,'0' as PYWCLR --15
  ,'0' as PYWSLD   
  ,NC_GET_CAN_STOP(gps.PYWCHS,gps.GP_LASTUPD_STSDATE,'PYWCAD') as PYWCAD
  ,gps.PYWTRS
  ,'' as PYWRMK 
  ,'S' as PYWRST --20
  ,gps.gp_bnksacc_no as PYWDBA
  ,'' as PYWCBA
  ,'' as PYWUPS
  ,'' as PYWOIC
  ,'' as PYWMON --25
  ,CASE WHEN PYWCHS = 'REJECT' and PYWTRS = 'SUCCESS' THEN '2'
        ELSE '' 
   END as PYWUPB
  ,'' as PYWREK
  ,'MIGNCUSR' as PYWCRU
  ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWCRD 
  ,'0' as PYWCRT --30
  ,'MIGNCUSR' as PYWLMU 
  ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWLMD
  ,'0' as PYWLMT
  ,'0' as PYWRPD
  ,'0' as PYWRKD
  ,'0' as PYWOCD
  ,'' as PYWNAC
  ,'' as PYWNCQ
  ,'' as PYWRQN      
  ,NC_GET_CAN_STOP(gps.PYWCHS,gps.GP_LASTUPD_STSDATE,'PYWSPD') as PYWSPD --40
  ,'SCB' as PYWBPN
  ,'NC' as PYWSRC
  ,'N'||gps.gp_custrefno as PYWPYN
  ,'' as PYWCHL
  ,'' as PYWRPY --45
  ,gps.gp_exptobank_filenme as PYWFRF
  ,'scblife' as PYWCID
  ,'' as PYWBRF
  ,CASE 
      WHEN (gps.GP_CORE_SYSTEM = 'TLM') THEN (select tscm.TREV_EFFECTIVE_DATE from Data_tscm tscm where tscm.aclk_account_number = gps.GP_POLNO and gps.gp_chqno = tscm.chqe_ext_chq_number and tscm.chqe_amount = gps.GP_AMOUNT and tscm.paiddate = gps.GP_PAIDDATE)    --TLM CLAM & POST
      WHEN pm_pol.source in ('C','D','E','L') or il.org_source in ('C','D','E','L') THEN 
          CASE
            WHEN (gps.ModuleCode = 'TCLM' and (pm_pol.source in ('C', 'D', 'L', 'E') or il.org_source in ('C','D','E','L') ) ) THEN  -- clam : as400,cl,csdm,tclm
              CASE 
                WHEN (select clm_type from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and clm_type = 'DEAD' and rownum = 1) is not null 
                  THEN (select to_char(risk_event_dte - 5430000) from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and clm_type = 'DEAD' and rownum = 1)
                ELSE (select to_char(decision_dte - 5430000) from data_conso.claim_transaction cltr where cltr.pol_no = gps.GP_POLNO and (cltr.payment_dte -5430000) = gps.GP_PAIDDATE and rownum = 1)
              END
            WHEN (gps.ModuleCode != 'TCLM' and (pm_pol.source = 'E' or il.org_source ='E' ))  -- AS400 POST
              THEN (select to_char(bonduedte - 5430000) from as400bnh where as400bnh.polnbr = gps.GP_POLNO and as400bnh.chqnbr = gps.GP_CHQNO and as400bnh.bonval = gps.GP_AMOUNT) 
            WHEN (gps.ModuleCode != 'TCLM'  and (pm_pol.source = 'C' or il.org_source ='C') ) THEN  -- CS POST
              CASE 
                WHEN (select to_char(w.pos_eff-5430000) from mig_bank_info u left join cs_poltrack w on w.pol_no = u.upd_polno where gps.GP_POLNO = w.pol_no and (paid_refd-5430000) = gps.GP_PAIDDATE and ref_no = gps.GP_CHQNO and bal_amt = gps.GP_AMOUNT) is not null THEN (select to_char(w.pos_eff-5430000) from mig_bank_info u left join cs_poltrack w on w.pol_no = u.upd_polno where gps.GP_POLNO = w.pol_no and (paid_refd-5430000) = gps.GP_PAIDDATE and ref_no = gps.GP_CHQNO and bal_amt = gps.GP_AMOUNT)
                ELSE null
              END
            WHEN gps.ModuleCode != 'TCLM' and (pm_pol.source in ('D','L') or il.org_source  in ('D','L') ) THEN '' -- Direct,CL POST
          END
      ELSE ''-- CASE WHEN il.org_source is null THEN 'Can not found INCURDATE IN SOURCE '||pm_pol.source ELSE 'Can not found INCURDATE IN SOURCE '|| il.org_source END 
    END as PYWCID
  ,CASE 
      WHEN (gps.PYWSTYP) = 'CCP' and gps.GP_PAYMTH = 'C' and gps.GP_SUB_PAYMTH = 'C' 
        THEN 
          CASE WHEN ((to_number(gps.GP_CHQNO) between 2035301 and 2235300 or to_number(gps.GP_CHQNO) between 5000001 and 5140000 or to_number(gps.GP_CHQNO) between 10000001 and 10070000)) THEN gps.PYWSTYP
          ELSE 'MCP'
          END
      ELSE
        gps.PYWSTYP
   END as PYWSTYP --50
  ,'Y' as PYWORG
  ,'' as PYWORN --52
  ,gps.GP_CORE_SYSTEM
  ,'GPS'
from data_gps_inscope gps
left join data_il.il_t_policy_mig il on gps.GP_POLNO = il.polnbr
left join polmstpf pm_pol on gps.GP_POLNO = pm_pol.polnbr
where
 gps.modulecode is not null
 and gps.GP_POLNO is not null
 
 
 -- MAP FOUND COULD LOG SOURCE INVALID ONLY 
INSERT INTO MIG_NC_INTERFACE --ROW 14: ,TIME : 0.16.997
select  
    CASE  
     WHEN t_gps.ModuleCode = 'TCLM' and (t_gps.GP_PAYEE_NAME like '%โรงพยาบาล%' or t_gps.GP_PAYEE_NAME like '%ร.พ.%')
        THEN substr(t_gps.GP_CUSTREFNO,2,15)
      ELSE
        CASE
          WHEN  il.polnbr is not null THEN 
            CASE
              WHEN (il.org_source) = 'T' THEN '3'||SUBSTR(t_gps.GP_POLNO,6,LENGTH(pm_pol.polnbr))
              ELSE il.polnbr
            END 
          ELSE
            CASE
             WHEN pm_pol.source = 'T' THEN '3'||SUBSTR(pm_pol.polnbr,6,LENGTH(pm_pol.polnbr))
             WHEN pm_pol.source = 'E' THEN CASE WHEN length(pm_pol.polnbr) = 8 THEN pm_pol.polnbr ELSE lpad(pm_pol.polnbr,8,'0') END 
             WHEN pm_pol.source = 'C' THEN '2'||SUBSTR(pm_pol.polnbr,1,2)
             WHEN pm_pol.source = 'D' THEN (SELECT  PREFIX||SUBSTR(pm_pol.polnbr,11,5) from mig_dm_pol_no_prefix where DM_INDEX = SUBSTR(pm_pol.polnbr,1,9))
             WHEN pm_pol.source = 'L' THEN 
               CASE 
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = pm_pol.polnbr)) = 0 THEN (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = pm_pol.polnbr)
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = pm_pol.polnbr)) = 0 THEN (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = pm_pol.polnbr)
                  ELSE 
                    pm_pol.polnbr -- LOG Data dupilcate from data_il.il_t_policy_mig
               END
             ELSE
               pm_pol.polnbr --INVALID SOURCE 
          END
      END
   END as WKREFN
  ,t_gps.gp_payee_name as PYWBEN
  ,t_gps.gp_confirmdate as PYWTRD 
  ,t_gps.gp_paiddate as PYWPYD
  ,t_gps.gp_amount as PYWAMT--5
  ,t_gps.gp_paydesc as PYWCM1
  ,'' as PYWCM2       
  ,ModuleCode as PYWMOD
  ,t_gps.PYWPYT
  ,NC_GET_BANK_ACC_CHQE(t_gps.GP_PAYMTH,t_gps.GP_BNKCODE,null,null,'PYWBNK') as PYWBNK --10
  ,NC_GET_BANK_ACC_CHQE(t_gps.GP_PAYMTH,null,t_gps.GP_PAYEE_BNKACCNO,null,'PYWACT') as PYWACT 
  ,t_gps.PYWTYP
  ,NC_GET_BANK_ACC_CHQE(t_gps.GP_PAYMTH,null,null,t_gps.GP_CHQNO,'PYWCHQ') as PYWCHQ
  ,t_gps.PYWCHS
  ,'0' as PYWCLR --15
  ,'0' as PYWSLD   
  ,NC_GET_CAN_STOP(t_gps.PYWCHS,t_gps.GP_LASTUPD_STSDATE,'PYWCAD') as PYWCAD
  ,t_gps.PYWTRS
  ,'' as PYWRMK 
  ,'S' as PYWRST --20
  ,t_gps.gp_bnksacc_no as PYWDBA
  ,'' as PYWCBA
  ,'' as PYWUPS
  ,'' as PYWOIC
  ,'' as PYWMON --25
  ,CASE WHEN PYWCHS = 'REJECT' and PYWTRS = 'SUCCESS' THEN '2'
        ELSE '' 
   END as PYWUPB
  ,'' as PYWREK
  ,'MIGNCUSR' as PYWCRU
  ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWCRD 
  ,'0' as PYWCRT --30
  ,'MIGNCUSR' as PYWLMU 
  ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWLMD
  ,'0' as PYWLMT
  ,'0' as PYWRPD
  ,'0' as PYWRKD
  ,'0' as PYWOCD
  ,'' as PYWNAC
  ,'' as PYWNCQ
  ,'' as PYWRQN      
  ,NC_GET_CAN_STOP(t_gps.PYWCHS,t_gps.GP_LASTUPD_STSDATE,'PYWSPD') as PYWSPD --40
  ,'SCB' as PYWBPN
  ,'NC' as PYWSRC
  ,'N'||t_gps.gp_custrefno as PYWPYN
  ,'' as PYWCHL
  ,'' as PYWRPY --45
  ,t_gps.gp_exptobank_filenme as PYWFRF
  ,'scblife' as PYWCID
  ,'' as PYWBRF
  ,CASE 
       WHEN (t_gps.GP_CORE_SYSTEM = 'TLM') THEN (select tscm.TREV_EFFECTIVE_DATE from Data_tscm tscm where tscm.aclk_account_number = t_gps.GP_POLNO and t_gps.gp_chqno = tscm.chqe_ext_chq_number and tscm.chqe_amount = t_gps.GP_AMOUNT and tscm.paiddate = t_gps.GP_PAIDDATE) --TLM CLAM & POST
      WHEN pm_pol.source in ('C','D','E','L') or il.org_source in ('C','D','E','L') THEN 
          CASE
            WHEN (t_gps.ModuleCode = 'TCLM' and (pm_pol.source in ('C', 'D', 'L', 'E') or il.org_source in ('C','D','E','L') ) ) THEN  -- clam : as400,cl,csdm,tclm
              CASE 
                WHEN (select clm_type from data_conso.claim_transaction cltr where cltr.pol_no = pm_pol.polnbr and (cltr.payment_dte -5430000) = t_gps.GP_PAIDDATE and clm_type = 'DEAD' and rownum = 1) is not null 
                  THEN (select to_char(risk_event_dte - 5430000) from data_conso.claim_transaction cltr where cltr.pol_no = pm_pol.polnbr and (cltr.payment_dte -5430000) = t_gps.GP_PAIDDATE and clm_type = 'DEAD' and rownum = 1)
                ELSE (select to_char(decision_dte - 5430000) from data_conso.claim_transaction cltr where cltr.pol_no = pm_pol.polnbr and (cltr.payment_dte -5430000) = t_gps.GP_PAIDDATE and rownum = 1)
              END
            WHEN (t_gps.ModuleCode != 'TCLM' and (pm_pol.source = 'E' or il.org_source ='E' ))  -- AS400 POST
              THEN (select to_char(bonduedte - 5430000) from as400bnh where as400bnh.polnbr = pm_pol.polnbr and as400bnh.chqnbr = t_gps.GP_CHQNO and as400bnh.bonval = t_gps.GP_AMOUNT) 
            WHEN (t_gps.ModuleCode != 'TCLM'  and (pm_pol.source = 'C' or il.org_source ='C') ) THEN  -- CS POST
              CASE 
                WHEN (select to_char(w.pos_eff-5430000) from mig_bank_info u left join cs_poltrack w on w.pol_no = u.upd_polno where pm_pol.polnbr = w.pol_no and (paid_refd-5430000) = t_gps.GP_PAIDDATE and ref_no = t_gps.GP_CHQNO and bal_amt = t_gps.GP_AMOUNT) is not null THEN (select to_char(w.pos_eff-5430000) from mig_bank_info u left join cs_poltrack w on w.pol_no = u.upd_polno where pm_pol.polnbr = w.pol_no and (paid_refd-5430000) = t_gps.GP_PAIDDATE and ref_no = t_gps.GP_CHQNO and bal_amt = t_gps.GP_AMOUNT)
                ELSE null
              END
            WHEN t_gps.ModuleCode != 'TCLM' and (pm_pol.source in ('D','L') or  il.org_source in ('D','L')) THEN '' -- Direct,CL POST
          END
      ELSE  null--CASE WHEN il.org_source is null THEN 'Can not found INCURDATE IN SOURCE '||pm_pol.source ELSE 'Can not found INCURDATE IN SOURCE '|| il.org_source END 
    END as PYWCID
   ,CASE 
      WHEN (t_gps.PYWSTYP) = 'CCP' and t_gps.GP_PAYMTH = 'C' and t_gps.GP_SUB_PAYMTH = 'C' 
        THEN 
          CASE WHEN ((to_number(t_gps.GP_CHQNO) between 2035301 and 2235300 or to_number(t_gps.GP_CHQNO) between 5000001 and 5140000 or to_number(t_gps.GP_CHQNO) between 10000001 and 10070000)) THEN t_gps.PYWSTYP
          ELSE 'MCP'
          END
      ELSE
        t_gps.PYWSTYP
   END as PYWSTYP --50
  ,'Y' as PYWORG
  ,'' as PYWORN --52
  ,t_gps.GP_CORE_SYSTEM
  ,'GPS'
from data_gps_inscope t_gps
inner join
(
  select * from(
    select trim(ttlnme||insfst||' '||inslst) as fullname,polnbr,source,
    COUNT(*) OVER (PARTITION BY ttlnme||insfst||' '||inslst) as cr
    from polmstpf
  ) pm
  where cr = 1 and polnbr is not null
)pm_pol on t_gps.GP_PAYEE_NAME = pm_pol.fullname
left join 
data_il.il_t_policy_mig il on pm_pol.polnbr = il.polnbr
where t_gps.ModuleCode is not null 
and t_gps.GP_POLNO is null
 
 
 INSERT INTO MIG_NC_INTERFACE
select
  '' as WKREFN
  ,t_gps.gp_payee_name as PYWBEN
  ,t_gps.gp_confirmdate as PYWTRD 
  ,t_gps.gp_paiddate as PYWPYD
  ,t_gps.gp_amount as PYWAMT--5
  ,t_gps.gp_paydesc as PYWCM1
  ,'' as PYWCM2       
  ,ModuleCode as PYWMOD
  ,t_gps.PYWPYT
  ,NC_GET_BANK_ACC_CHQE(t_gps.GP_PAYMTH,t_gps.GP_BNKCODE,null,null,'PYWBNK') as PYWBNK --10
  ,NC_GET_BANK_ACC_CHQE(t_gps.GP_PAYMTH,null,t_gps.GP_PAYEE_BNKACCNO,null,'PYWACT') as PYWACT 
  ,t_gps.PYWTYP
  ,NC_GET_BANK_ACC_CHQE(t_gps.GP_PAYMTH,null,null,t_gps.GP_CHQNO,'PYWCHQ') as PYWCHQ
  ,t_gps.PYWCHS
  ,'0' as PYWCLR --15
  ,'0' as PYWSLD   
  ,NC_GET_CAN_STOP(t_gps.PYWCHS,t_gps.GP_LASTUPD_STSDATE,'PYWCAD') as PYWCAD
  ,t_gps.PYWTRS
  ,'' as PYWRMK 
  ,'S' as PYWRST --20
  ,t_gps.gp_bnksacc_no as PYWDBA
  ,'' as PYWCBA
  ,'' as PYWUPS
  ,'' as PYWOIC
  ,'' as PYWMON --25
  ,CASE WHEN t_gps.PYWCHS = 'REJECT' and t_gps.PYWTRS = 'SUCCESS' THEN '2'
        ELSE '' 
   END as PYWUPB
  ,'' as PYWREK
  ,'MIGNCUSR' as PYWCRU
  ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWCRD 
  ,'0' as PYWCRT --30
  ,'MIGNCUSR' as PYWLMU 
  ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWLMD
  ,'0' as PYWLMT
  ,'0' as PYWRPD
  ,'0' as PYWRKD
  ,'0' as PYWOCD
  ,'' as PYWNAC
  ,'' as PYWNCQ
  ,'' as PYWRQN      
  ,NC_GET_CAN_STOP(t_gps.PYWCHS,t_gps.GP_LASTUPD_STSDATE,'PYWSPD') as PYWSPD --40
  ,'SCB' as PYWBPN
  ,'NC' as PYWSRC
  ,'N'||t_gps.gp_custrefno as PYWPYN
  ,'' as PYWCHL
  ,'' as PYWRPY --45
  ,t_gps.gp_exptobank_filenme as PYWFRF
  ,'scblife' as PYWCID
  ,'' as PYWBRF
  ,''as PYWCID
   ,CASE 
      WHEN (t_gps.PYWSTYP) = 'CCP' and t_gps.GP_PAYMTH = 'C' and t_gps.GP_SUB_PAYMTH = 'C' 
        THEN 
          CASE WHEN ((to_number(t_gps.GP_CHQNO) between 2035301 and 2235300 or to_number(t_gps.GP_CHQNO) between 5000001 and 5140000 or to_number(t_gps.GP_CHQNO) between 10000001 and 10070000)) THEN t_gps.PYWSTYP
          ELSE 'MCP'
          END
      ELSE
        t_gps.PYWSTYP
   END as PYWSTYP --50
  ,'Y' as PYWORG
  ,'' as PYWORN --52
  ,t_gps.GP_CORE_SYSTEM
  ,'GPS'
from data_gps_inscope t_gps 
left join mig_nc_interface ifc on 'N'||t_gps.gp_custrefno = ifc.pywpyn
and t_gps.GP_PAYEE_NAME = ifc.pywben
where t_gps.ModuleCode is not null
and ifc.pywref is null


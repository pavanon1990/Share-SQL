INSERT INTO MIG_NC_TPYFILNC
select  
   CASE 
     WHEN il.org_source is not null THEN il.polnbril
     ELSE --POLMSTPF
       CASE 
         WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) is not null -- CHECK SOURCE
           THEN 
             CASE --SOURCE IN I E C D L
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'T' THEN '3'||SUBSTR(gps.GP_POLNO,6,LENGTH(gps.GP_POLNO))
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'E' THEN CASE WHEN length(gps.GP_POLNO) = 8 THEN gps.GP_POLNO ELSE lpad(gps.GP_POLNO,8,'0') END 
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'C' THEN '2'||SUBSTR(gps.GP_POLNO,1,2)
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'D' THEN (SELECT  PREFIX||SUBSTR(gps.GP_POLNO,11,5) from mig_dm_pol_no_prefix where DM_INDEX = SUBSTR(gps.GP_POLNO,1,9)) 
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'L' THEN    
                CASE 
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)) = 0 THEN (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)) = 0 THEN (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)
                  ELSE 
                    gps.GP_POLNO -- LOG Data dupilcate from data_il.il_t_policy_mig
                END
               ELSE
                  gps.GP_POLNO--'SOURCE INVAID '|| (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1)
             END
         ELSE -- TSCM_ACCOUNT_LINK  
           CASE WHEN (select acl.aclk_account_number from tscm_account_link acl where acl.aclk_account_number = gps.GP_POLNO) is not null 
             THEN '3'||SUBSTR(gps.GP_POLNO,6,LENGTH(gps.GP_POLNO))
             ELSE gps.GP_POLNO
           END
       END
   END as WKREFN
    ,gps.GP_POLNO as WKORGN 
    --,(select pm.source from polmstpf pm where pm.polnbr = gps.GP_POLNO) as pm_Source
    ,nc_tpyfilnc_policy_status(clnt_pol.relationship_type) as WKROLE
   ,'NC' as WKSRCS
   ,( select substr(polsts,1,2) from polmstpf  t where POLNBR = gps.GP_POLNO) as WKPSTS ----5
   ,( select t.agcde2 from polmstpf  t where POLNBR = gps.GP_POLNO) as WKAGNT 
   ,(select pm.plncde from polmstpf pm where pm.polnbr = gps.GP_POLNO ) 
   
   as PLNCD
   ,(select clp.clientid from data_conso.cclient_pol clp where clp.policynumber = gps.GP_POLNO and clp.relationship_type = 'OWNR' and rownum = 1 ) as WKCNUM 
    ,'P' as WKCTYP
    ,(select t.Idno from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKIDNO  ----- 10
    ,(select substr(t.ttlnme,0,9) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKTTLN 
    ,(select substr(t.INSFST,0,30) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKFSNM 
    ,'' as WKMDNM
    ,(select substr(t.INSLST,0,30) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKLSNM 
    ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN CASE WHEN length(clnt_add.address1) > 30  THEN substr(clnt_add.address1,1,30) ELSE clnt_add.address1 END ELSE '' END as WKADD1  --15
    ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN CASE WHEN length(clnt_add.address2) > 30  THEN substr(clnt_add.address2,1,30) ELSE clnt_add.address2 END ELSE '' END as WKADD2
    ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.sub_district ELSE '' END as WKADD3
    ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.district ELSE '' END as WKADD4
    ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.province ELSE '' END as WKPROV
    ,CASE WHEN clnt_pol.relationship_type = 'DESA' THEN clnt_add.postcode ELSE '' END as WKZIPC
    ,(select g.GP_CORE_SYSTEM from data_gps_inscope g where g.GP_POLNO = gps.GP_POLNO and rownum = 1)
    ,(select g.ModuleCode from data_gps_inscope g where g.GP_POLNO = gps.GP_POLNO and rownum = 1) 
    ,'GPS'
from( --7648
select gps.GP_POLNO from data_gps_inscope gps
where gps.modulecode is not null --and gps.GP_POLNO is not null
GROUP By gps.GP_POLNO
) gps
left join data_conso.cclient_pol clnt_pol on gps.GP_POLNO = clnt_pol.POLICYNUMBER and clnt_pol.recordstatus = 1 and clnt_pol.relationship_type != 'LIF2'
left join data_conso.clientaddress clnt_add on clnt_pol.clientaddressid = clnt_add.clientaddressid
left join data_il.il_t_policy_mig il on gps.GP_POLNO = il.polnbr
where clnt_pol.clientaddressid is not null;
COMMIT;

INSERT INTO MIG_NC_TPYFILNC_2
select  
   CASE 
     WHEN il.org_source is not null THEN il.polnbril
     ELSE --POLMSTPF
       CASE 
         WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) is not null -- CHECK SOURCE
           THEN 
             CASE --SOURCE IN I E C D L
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'T' THEN '3'||SUBSTR(gps.GP_POLNO,6,LENGTH(gps.GP_POLNO))
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'E' THEN CASE WHEN length(gps.GP_POLNO) = 8 THEN gps.GP_POLNO ELSE lpad(gps.GP_POLNO,8,'0') END 
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'C' THEN '2'||SUBSTR(gps.GP_POLNO,1,2)
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'D' THEN (SELECT  PREFIX||SUBSTR(gps.GP_POLNO,11,5) from mig_dm_pol_no_prefix where DM_INDEX = SUBSTR(gps.GP_POLNO,1,9)) 
               WHEN (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1) = 'L' THEN    
                CASE 
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)) = 0 THEN (select '15'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)
                  WHEN 
                    (select count(POLNBRIL) from data_il.il_t_policy_mig where POLNBRIL = (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)) = 0 THEN (select '16'||a.polnbr from data_conso.polmstpf a where a.polnbr = gps.GP_POLNO)
                  ELSE 
                    gps.GP_POLNO -- LOG Data dupilcate from data_il.il_t_policy_mig
                END
               ELSE
                  gps.GP_POLNO--'SOURCE INVAID '|| (select source from polmstpf pom where pom.polnbr = gps.GP_POLNO and rownum = 1)
             END
         ELSE -- TSCM_ACCOUNT_LINK  
           CASE WHEN (select acl.aclk_account_number from tscm_account_link acl where acl.aclk_account_number = gps.GP_POLNO) is not null 
             THEN '3'||SUBSTR(gps.GP_POLNO,6,LENGTH(gps.GP_POLNO))
             ELSE gps.GP_POLNO
           END
       END
   END as WKREFN
    ,gps.GP_POLNO as WKORGN 
    ,'ADD' as WKROLE
   ,'NC' as WKSRCS
   ,( select substr(polsts,1,2) from polmstpf  t where POLNBR = gps.GP_POLNO) as WKPSTS ----5
   ,( select t.agcde2 from polmstpf  t where POLNBR = gps.GP_POLNO) as WKAGNT 
   ,(select pm.plncde from polmstpf pm where pm.polnbr = gps.GP_POLNO ) 
      as PLNCD
   ,(select clp.clientid from data_conso.cclient_pol clp where clp.policynumber = gps.GP_POLNO and clp.relationship_type = 'OWNR' and rownum = 1 ) as WKCNUM 
    ,'P' as WKCTYP
    ,(select t.Idno from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKIDNO  ----- 10
    ,(select substr(t.ttlnme,0,9) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKTTLN 
    ,(select substr(t.INSFST,0,30) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKFSNM 
    ,'' as WKMDNM
    ,(select substr(t.INSLST,0,30) from data_conso.polmstpf  t where POLNBR = gps.GP_POLNO) as WKLSNM 
    ,CASE WHEN length(clnt_add.address1) > 30  THEN substr(clnt_add.address1,1,30) ELSE clnt_add.address1 END as WKADD1 --15
    ,CASE WHEN length(clnt_add.address2) > 30  THEN substr(clnt_add.address2,1,30) ELSE clnt_add.address2 END as WKADD2
    ,clnt_add.sub_district as WKADD3
    ,clnt_add.district as WKADD4
    ,clnt_add.province as WKPROV
    ,clnt_add.postcode as WKZIPC
    ,(select g.GP_CORE_SYSTEM from data_gps_inscope g where g.GP_POLNO = gps.GP_POLNO and rownum = 1)
    ,(select g.ModuleCode from data_gps_inscope g where g.GP_POLNO = gps.GP_POLNO and rownum = 1) 
    ,'GPS'
from( --7648
select gps.GP_POLNO from data_gps_inscope gps
where gps.modulecode is not null --and gps.GP_POLNO is not null
and NOT EXISTS  (
          select  
            GP_POLNO --DESA
          from( 
            select gp.GP_POLNO from data_gps_inscope gp
            where gp.modulecode is not null  and gp.GP_POLNO is not null
            GROUP By gp.GP_POLNO
          ) gp
          left join data_conso.cclient_pol ccpol on gp.GP_POLNO = ccpol.POLICYNUMBER and ccpol.recordstatus = 1 and ccpol.relationship_type != 'LIF2'
          where ccpol.clientaddressid is not null 
          and ccpol.relationship_type  = 'DESA'
          and gp.GP_POLNO = gps.GP_POLNO
)


GROUP By gps.GP_POLNO
) gps
left join data_conso.cclient_pol clnt_pol on gps.GP_POLNO = clnt_pol.POLICYNUMBER and clnt_pol.recordstatus = 1 and clnt_pol.relationship_type = 'OWNR'
left join data_conso.clientaddress clnt_add on clnt_pol.clientaddressid = clnt_add.clientaddressid
left join data_il.il_t_policy_mig il on gps.GP_POLNO = il.polnbr
where clnt_pol.clientaddressid is not null;
COMMIT;


WITH viewtable as (
select 
    CASE
    WHEN (CASE 
          WHEN gps.gp_core_system = 'TLM' 
               THEN
                 ( select trans_value01 from MIG_T_MAPPING t 
                    where SYSTEM_NAME = 'GPS' and trans_code = 'C03' 
                    and TRANS_S01 = gps.gp_core_system
                    and gps.gp_paydesc  like '%'||trans_s02||'%'
                    and trans_s03 is null ) 
                ELSE
                  (select trans_value01 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C03' 
                      and TRANS_S01 = gps.gp_core_system
                      and TRANS_S02 = substr(gps.gp_transref,1,3)
                      and trans_s03 is null) 
                 END) = 'TCLM' and (gps.gp_payee_name like '%โรงพยาบาล%' or gps.gp_payee_name like '%ร.พ.%')
     THEN SUBSTR(gps.gp_custrefno,2,LENGTH(gps.gp_custrefno))
     ELSE
          case 
                 when gps.gp_core_system = 'TLM' 
                      then '3'||SUBSTR(gps.gp_polno,6,LENGTH(gps.gp_polno))
                      else gps.gp_polno
          end
     END as PYWREF
    ,gps.gp_payee_name as PYWBEN
    ,gps.gp_confirmdate as PYWTRD
    ,gps.gp_paiddate as PYWPYD
    ,to_char(gps.gp_amount, 'fm9999999.90') as PYWAMT -- split value
    ,gps.gp_paydesc as PYWCM1
    ,'' as PYWCM2
    ,CASE 
      WHEN gps.gp_core_system = 'TLM' 
        THEN 
          (select trans_value01 from MIG_T_MAPPING t 
          where SYSTEM_NAME = 'GPS' and trans_code = 'C03' 
          and TRANS_S01 = gps.gp_core_system 
          and gps.gp_paydesc  like '%'||trans_s02||'%'
          ) 
        ELSE 
          (select trans_value01 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C03' 
                      and TRANS_S01 = gps.gp_core_system
                      and TRANS_S02 = substr(gps.gp_transref,1,3)
                      and trans_s03 is null) 
        END as  PYWMOD --,gps.gp_transref ,gps.gp_core_system -- CHECK PYWMOD 
        ,(select trans_value01 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C02' 
                      and TRANS_S01 = gps.GP_PAYMTH
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and trans_s03 is null) as PYWPYT
        ,CASE
           WHEN gps.gp_paymth = 'C' or  gps.gp_paymth = 'D' 
             THEN ''
           ELSE gps.GP_BNKCODE
         END
        as PYWBNK
        ,CASE
           WHEN gps.gp_paymth = 'C' or  gps.gp_paymth = 'D' 
             THEN ''
           ELSE gps.GP_PAYEE_BNKACCNO
         END
        as PYWACT
        ,(select trans_value01 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C04' 
                      and TRANS_S01 = gps.GP_PAYMTH
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and trans_s03 is null) as PYWTYP
        ,CASE 
             WHEN gps.gp_paymth = 'C' or  gps.gp_paymth = 'D' 
             THEN gps.gp_chqno
             ELSE ''
         END as PYWCHQ
        ,(select trans_value01 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C01' 
                      and TRANS_S01 = gps.GP_PAYMTH
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and TRANS_S03 = gps.gp_lastupd_sts
         )
         as PYWCHS --R26
         ,'0' as PYWCLR
         ,'0' as PYWSLD
         , CASE 
           WHEN gps.gp_paymth = 'C' and gps.gp_sub_paymth = 'C' and gps.gp_lastupd_sts = 'S' 
             THEN gps.gp_lastupd_stsdate
             ELSE '0'
           END
         as PYWCAD
         ,(select trans_value02 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C01' 
                      and TRANS_S01 = gps.GP_PAYMTH
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and TRANS_S03 = gps.gp_lastupd_sts
         )
         as PYWTRS --R26
         ,'' as PYWRMK 
         ,'S' as PYWRST --20
         ,gps.gp_bnksacc_no as PYWDBA
         ,'' as PYWCBA
         ,'' as PYWUPS
         ,'' as PYWOIC
         ,'' as PYWMON --25
         ,CASE 
             WHEN (select trans_value01 from MIG_T_MAPPING t where SYSTEM_NAME = 'GPS' 
                      and trans_code = 'C01' 
                      and TRANS_S01 = gps.GP_PAYMTH 
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and TRANS_S03 = gps.gp_lastupd_sts
             ) = 'REJECT' --PYWCHS
             AND 
             (select trans_value02 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C01' 
                      and TRANS_S01 = gps.GP_PAYMTH
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and TRANS_S03 = gps.gp_lastupd_sts
             ) = 'SUCCESS' --PYWTRS
             THEN '2'
             ELSE ''
             END as PYWUPB
             ,'' as PYWREK
             ,'MIGNCUSR' as PYWCRU
             ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWCRD 
             ,'0' as PYWCRT --30
             ,'MIGNCUSR' as PYWLMU 
             ,TO_CHAR(SYSDATE, 'YYYYMMDD') as PYWLMD
             ,'0' as PYWLMT
             ,'0' as PYWRPD
             ,'0' as PYWRKD
             ,'0' as PYWOCD
             ,'' as PYWNAC
             ,'' as PYWNCQ
             ,'' as PYWRQN
             ,CASE
                WHEN gps.gp_paymth = 'C' and gp_sub_paymth = 'C' and gp_lastupd_sts = 'S'
                THEN gps.gp_lastupd_stsdate
                ELSE ''
              END
              as PYWSPD --40
             ,'SCB' as PYWBPN
             ,'NC' as PYWSRC
             ,'N'||gps.gp_custrefno as PYWPYN
             ,'' as PYWCHL
             ,'' as PYWRPY
             ,gps.gp_exptobank_filenme as PYWFRF
             ,'scblife' as PYWCID
             ,'' as PYWBRF
             ,'' as PYWICD -- Wait logic incurred date
             ,(select trans_value02 from MIG_T_MAPPING t 
                      where SYSTEM_NAME = 'GPS' and trans_code = 'C04' 
                      and TRANS_S01 = gps.GP_PAYMTH
                      and TRANS_S02 = gps.GP_SUB_PAYMTH
                      and TRANS_S03 is null
              ) as PYWSTYP --50
             ,'Y' as PYWORG
             ,'' as PYWORN
             ,gps.gp_custrefno
             ,gps.gp_polno
             ,gps.gp_payee_name
             ,gps.gp_chqno
             ,gps.gp_core_system
             ,gps.Gp_Paymth
             ,gps.GP_SUB_PAYMTH
             ,gps.GP_TRANSREF
             ,gps.GP_PAYDESC
             ,gps.GP_LASTUPD_STS
from GPS_PAYMENT gps
)
select 
     CASE WHEN t.Pywref is not null THEN RPAD(t.Pywref,15) ELSE rpad(' ', 15) END || CASE WHEN t.Pywben is not null THEN RPAD(t.Pywben,70) ELSE rpad(' ', 70) END
     ||CASE WHEN t.Pywtrd is not null THEN RPAD(t.Pywtrd,8) ELSE rpad(' ', 8) END || CASE WHEN t.Pywpyd is not null THEN RPAD(t.Pywpyd,8) ELSE rpad(' ', 8) END
     ||CASE WHEN t.Pywamt is not null THEN LPAD(t.Pywamt,15) ELSE rpad(' ', 15) END || CASE WHEN t.Pywcm1 is not null THEN RPAD(t.Pywcm1,50) ELSE rpad(' ', 50) END
     ||CASE WHEN t.Pywcm2 is not null THEN RPAD(t.Pywcm2,50) ELSE rpad(' ', 50) END || CASE WHEN t.Pywmod is not null THEN RPAD(t.Pywmod,10) ELSE rpad(' ', 10) END
     ||CASE WHEN t.Pywpyt is not null THEN RPAD(t.Pywpyt,3) ELSE rpad(' ', 3) END || CASE WHEN t.Pywbnk is not null THEN RPAD(t.Pywbnk,15) ELSE rpad(' ', 15) END -- 10
     ||CASE WHEN t.Pywact is not null THEN RPAD(t.Pywact,20) ELSE rpad(' ', 20) END || CASE WHEN t.Pywtyp is not null THEN RPAD(t.Pywtyp,3) ELSE rpad(' ', 3) END
     ||CASE WHEN t.Pywchq is not null THEN RPAD(t.Pywchq,15) ELSE rpad(' ', 15) END || CASE WHEN t.Pywchs is not null THEN RPAD(t.Pywchs,15) ELSE rpad(' ', 15) END
     ||CASE WHEN t.Pywclr is not null THEN RPAD(t.Pywclr,8) ELSE rpad(' ', 8) END || CASE WHEN t.Pywsld is not null THEN RPAD(t.Pywsld,8) ELSE rpad(' ', 8) END
     ||CASE WHEN t.Pywcad is not null THEN RPAD(t.Pywcad,8) ELSE rpad(' ', 8) END || CASE WHEN t.Pywtrs is not null THEN RPAD(t.Pywtrs,15) ELSE rpad(' ', 15) END
     ||CASE WHEN t.Pywrmk is not null THEN RPAD(t.Pywrmk,70) ELSE rpad(' ', 70) END || CASE WHEN t.Pywrst is not null THEN RPAD(t.Pywrst,2) ELSE rpad(' ', 2) END --20
     ||CASE WHEN t.Pywdba is not null THEN RPAD(t.Pywdba,15) ELSE rpad(' ', 15) END || CASE WHEN t.Pywcba is not null THEN RPAD(t.Pywcba,15) ELSE rpad(' ', 15) END
     ||CASE WHEN t.Pywups is not null THEN RPAD(t.Pywups,2) ELSE rpad(' ', 2) END || CASE WHEN t.Pywoic is not null THEN RPAD(t.Pywoic,5) ELSE rpad(' ', 5) END
     ||CASE WHEN t.Pywmon is not null THEN RPAD(t.Pywmon,10) ELSE rpad(' ', 10) END || CASE WHEN t.Pywupb is not null THEN RPAD(t.Pywupb,10) ELSE rpad(' ', 10) END
     ||CASE WHEN t.Pywrek is not null THEN RPAD(t.Pywrek,1) ELSE rpad(' ', 1) END || CASE WHEN t.Pywcru is not null THEN RPAD(t.Pywcru,10) ELSE rpad(' ', 10) END
     ||CASE WHEN t.Pywcrd is not null THEN RPAD(t.Pywcrd,8) ELSE rpad(' ', 8) END || CASE WHEN t.Pywcrt is not null THEN RPAD(t.Pywcrt,6) ELSE rpad(' ', 6) END --30
     ||CASE WHEN t.Pywlmu is not null THEN RPAD(t.Pywlmu,10) ELSE rpad(' ', 10) END || CASE WHEN t.Pywlmd is not null THEN RPAD(t.Pywlmd,8) ELSE rpad(' ', 8) END
     ||CASE WHEN t.Pywlmt is not null THEN RPAD(t.Pywlmt,6) ELSE rpad(' ', 6) END || CASE WHEN t.Pywrpd is not null THEN RPAD(t.Pywrpd,8) ELSE rpad(' ', 8) END
     ||CASE WHEN t.Pywrkd is not null THEN RPAD(t.Pywrkd,8) ELSE rpad(' ', 8) END || CASE WHEN t.Pywocd is not null THEN RPAD(t.Pywocd,8) ELSE rpad(' ', 8) END
     ||CASE WHEN t.Pywnac is not null THEN RPAD(t.Pywnac,20) ELSE rpad(' ', 20) END || CASE WHEN t.Pywncq is not null THEN RPAD(t.Pywncq,15) ELSE rpad(' ', 15) END
     ||CASE WHEN t.Pywrqn is not null THEN RPAD(t.Pywrqn,11) ELSE rpad(' ', 11) END || CASE WHEN t.Pywspd is not null THEN RPAD(t.Pywspd,8) ELSE rpad(' ', 8) END --40
     ||CASE WHEN t.Pywbpn is not null THEN RPAD(t.Pywbpn,15) ELSE rpad(' ', 15) END || CASE WHEN t.Pywsrc is not null THEN RPAD(t.Pywsrc,3) ELSE rpad(' ', 3) END
     ||CASE WHEN t.Pywpyn is not null THEN RPAD(t.Pywpyn,30) ELSE rpad(' ', 30) END || CASE WHEN t.Pywchl is not null THEN RPAD(t.Pywchl,1) ELSE rpad(' ', 1) END
     ||CASE WHEN t.Pywrpy is not null THEN RPAD(t.Pywrpy,15) ELSE rpad(' ', 15) END || CASE WHEN t.Pywfrf is not null THEN RPAD(t.Pywfrf,60) ELSE rpad(' ', 60) END
     ||CASE WHEN t.Pywcid is not null THEN RPAD(t.Pywcid,12) ELSE rpad(' ', 12) END || CASE WHEN t.Pywbrf is not null THEN RPAD(t.Pywbrf,30) ELSE rpad(' ', 30) END
     ||CASE WHEN t.Pywicd is not null THEN RPAD(t.Pywicd,8) ELSE rpad(' ', 8) END || CASE WHEN t.Pywstyp is not null THEN RPAD(t.Pywstyp,3) ELSE rpad(' ', 3) END --50
     ||CASE WHEN t.Pyworg is not null THEN RPAD(t.Pyworg,1) ELSE rpad(' ', 1) END || CASE WHEN t.Pyworn is not null THEN RPAD(t.Pyworn,20) ELSE rpad(' ', 20) END
     as getdata
     ,t.gp_custrefno,t.gp_polno
     ,t.Pywref
     ,t.gp_payee_name
     ,t.PYWACT
     ,t.PYWCHQ
     ,t.PYWTYP
     ,t.PYWPYT
     ,t.PYWMOD
     ,t.GP_CORE_SYSTEM
     ,t.GP_PAYMTH
     ,t.GP_SUB_PAYMTH
     ,t.GP_TRANSREF
     ,t.GP_PAYDESC
     ,t.GP_LASTUPD_STS
     ,t.PYWTRS
     ,t.PYWSTYP
     ,t.PYWCHS
from viewtable t
where
(t.gp_paymth != 'C' and t.gp_sub_paymth != 'C' and t.gp_lastupd_sts != 'W') or
(t.gp_paymth != 'D' and t.gp_sub_paymth != 'D' and t.gp_lastupd_sts != 'P') or
(t.gp_paymth != 'D' and t.gp_sub_paymth != 'D' and t.gp_lastupd_sts != 'W') or
(t.gp_paymth != 'M' and t.gp_sub_paymth != 'A' and t.gp_lastupd_sts != 'S') or
(t.gp_paymth != 'M' and t.gp_sub_paymth != 'B' and t.gp_lastupd_sts != 'S') or
(t.gp_paymth != 'M' and t.gp_sub_paymth != 'C' and t.gp_lastupd_sts != 'S') or
(t.gp_paymth != 'M' and t.gp_sub_paymth != 'M' and t.gp_lastupd_sts != 'W') or
(t.gp_paymth != 'M' and t.gp_sub_paymth != 'M' and t.gp_lastupd_sts != 'S')    

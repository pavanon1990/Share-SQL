CREATE OR REPLACE PROCEDURE PEP_SP_GET_TRAN_CTEB_DETAIL (P_ACLK_ID VARCHAR2,P_TREV_ID VARCHAR2, REFCURSOR OUT SYS_REFCURSOR)
AS
BEGIN
/******************************************************************************
   NAME:       PEP_SP_GET_TRAN_CTEB_DETAIL
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        05/09/2017      Amornsin K.       1. Created procedure. PEP_SP_GET_TRAN_CTEB_DETAIL(Client Trans Event Bridge)
   1.0        05/09/2017      Amornsin K.       1. CTEB.CTEB_PAYMENT_IND <> 0 แสดงเฉพาะข้อมูลที่ไม่ใช่ "ไม่มีการชำระเงิน"
   1.0        7/09/2017       Amornsin K.       1. Add Field tran_type
   1.0        27/09/2017      Amornsin K.       1. Add Field tran_type
                                                    --'' "สถานะ",
                                                    --'' "สถานที่พิ",
                                                    --'' "วันที่ชำระ",
   1.0        04/10/2017      Amornsin K.       1. edit CTEB_DATE_PAID
   1.0        05/10/2017      Amornsin K.       1. แก้ไข CTEB_CHQE_STATUS_CODE_ID if Cheq cteb_cheq_status_code_id
                                                2. แก้ไข CTEB_CHQE_STATUS_CODE_ID if Cheq mt_transaction_status_code_id
                                                3. แก้ไข CTEB_DATE_PAID
   1.0        06/10/2017      Amornsin K.       1. แก้ไข CTEB_CHQE_STATUS_CODE_ID if Cheq cteb_cheq_status_code_id
                                                2. แก้ไข CTEB_CHQE_STATUS_CODE_ID if Cheq mt_transaction_status_code_id
                                                3. CHANGE "WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Prem From Susp' THEN " TO ELSE
   1.0        01/11/2017      Amornsin K.       ชำระเงินออก แก้ไข date paid
                                                WHEN CTEB.CTEB_PAYMENT_IND = -1 THEN
                                                  CASE
                                                    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN PEP_PKG.CONVERT_DATE(CHQE.CHQE_DATE_PRINTED)
                                                    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Credit card','Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTRB.MTRB_DATE_AUTHORISED) --PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
                                                    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit') THEN PEP_PKG.CONVERT_DATE(MTTR.MTTR_GP_UPLOAD_DATE) --PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
                                                  END
   1.0        01/11/2017      Amornsin K.       edit CTEB_DATE_PAID is Direct credit  date MTTR_GP_UPLOAD_DATE change to MTTR_DUE_DATE
  END CTEB_DATE_PAID
******************************************************************************/


  OPEN REFCURSOR FOR
  select * from (
 SELECT distinct
  null appl_id,
  CASE
    WHEN trim(CLNT.CLNT_MAILING_NAME) IS NOT NULL THEN CLNT.CLNT_MAILING_NAME
    ELSE CLNT.CLNT_SURNAME
  END CTEB_CLNT_MAILING_NAME,
  /*CASE WHEN RCPT.RCPT_ID IS NOT NULL THEN PEP_PKG.CONVERT_CURRENCY_TH(APPL.APPL_AMOUNT) || 'A'
       ELSE PEP_PKG.CONVERT_CURRENCY_TH(CTEB.CTEB_AMOUNT) || 'B'
  END CTEB_AMOUNT,*/
  --PEP_PKG.CONVERT_CURRENCY_TH(APPL.APPL_AMOUNT) APPL_AMOUNT,
  PEP_PKG.CONVERT_CURRENCY_TH(CTEB.CTEB_AMOUNT) CTEB_AMOUNT,
  --PEP_PKG.CONVERT_CURRENCY_TH(CTEB.CTEB_AMOUNT) CTEB_AMOUNT,
  CTEB.CTEB_PERCENTAGE,
  PAYMENT_CODE.CODE_SHORT_DESCRIPTION CTEB_PAYMT_METHOD_CODE_ID,
  CASE
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Company cheque' THEN cteb.cteb_cheque_payee_name
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Direct Debit' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Credit card' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Direct credit' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Bank draft' THEN cteb.cteb_cheque_payee_name
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Cheque payment' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Salary deduction' THEN cteb.cteb_bank_account
       ELSE PAYMENT_CODE.CODE_SHORT_DESCRIPTION
  END CTEB_DESCRIPTION,
  --MTRB.MTRB_BATCH_NUMBER CTEB_NUMBER,
/*  CASE
    WHEN CHQE.CHQE_ID IS NOT NULL THEN TO_CHAR(CHQE.CHQE_EXT_CHQ_NUMBER)
    WHEN MTRB.MTRB_ID IS NOT NULL THEN TO_CHAR(MTRB.MTRB_BATCH_NUMBER)
  END CTEB_NUMBER,*/
  CASE
    WHEN cteb_payment_ind = 1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION IN ('Direct credit','Direct Debit','Credit card','Direct debit payment','Credit card payment') THEN TO_CHAR(MTRB.MTRB_BATCH_NUMBER)
        --ELSE TO_CHAR(RCPT.RCPT_RECEIPT_NUMBER)
      END
    WHEN cteb_payment_ind = -1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN TO_CHAR(CHQE.CHQE_CHEQUE_NUMBER)
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit payment','Cash payment') THEN TO_CHAR(mtrb.mtrb_batch_number)
      END
  END CTEB_NUMBER,
  CTEB.CTEB_PAYMENT_IND,
  CHQE.CHQE_EXT_CHQ_NUMBER CTEB_CHQE_EXT_CHQ_NUMBER,
  CHQESTS_CODE.CODE_SHORT_DESCRIPTION CTEB_CHQE_EXT_STATUS_CODE_ID, -- สถานะเช็ค
  --CHQE_CODE.CODE_SHORT_DESCRIPTION CTEB_CHQE_STATUS_CODE_ID,--สถานะ
  --MTTRN_CODE.CODE_SHORT_DESCRIPTION CTEB_CHQE_STATUS_CODE_ID,--สถานะ
  /*CASE
    WHEN CHQE.CHQE_ID IS NOT NULL THEN CHQE_CODE.CODE_SHORT_DESCRIPTION
    WHEN MTTR.MTTR_ID IS NOT NULL THEN MTTRN_CODE.CODE_SHORT_DESCRIPTION
  END CTEB_CHQE_STATUS_CODE_ID,*/
  CASE
    WHEN CTEB.CTEB_PAYMENT_IND = 1 THEN
      CASE
        WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Paymt Into Susp' THEN
          CASE
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Credit card','Direct Debit') THEN MTTR_CODE.CODE_SHORT_DESCRIPTION
            --WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Cash payment') THEN NVL(TSPT.TSPT_TRANSLATION,APPL_CODE.CODE_SHORT_DESCRIPTION)
          END
        /*ELSE --WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Prem From Susp' THEN EIDT
          CASE
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Cash payment') THEN NVL(TSPT.TSPT_TRANSLATION,APPL_CODE.CODE_SHORT_DESCRIPTION)
          END*/

      END
    WHEN CTEB.CTEB_PAYMENT_IND = -1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN MTTR_CODE.CODE_SHORT_DESCRIPTION
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN CHQE_CODE.CODE_SHORT_DESCRIPTION
      END
  END CTEB_CHQE_STATUS_CODE_ID,
  PRINT_CODE.CODE_SHORT_DESCRIPTION CTEB_CHEQUE_PRINTER_CODE_ID, --'' "สถานที่พิ",
  CASE
    WHEN CTEB.CTEB_PAYMENT_IND = 1 THEN
      CASE
        WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Paymt Into Susp' THEN
          CASE
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTRB.MTRB_DATE_AUTHORISED)-- PEP_PKG.CONVERT_DATE(MTRB.MTRB_DATE_AUTHORISED)
          END
      END
    WHEN CTEB.CTEB_PAYMENT_IND = -1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN PEP_PKG.CONVERT_DATE(CHQE.CHQE_DATE_PRINTED)
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTRB.MTRB_DATE_AUTHORISED) --PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Credit card','Direct credit') THEN PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE) --PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
      END
  END CTEB_DATE_PAID,
/*  CASE
    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN PEP_PKG.CONVERT_DATE(CHQE.CHQE_GP_UPLOAD_DATE)
    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
  END CTEB_DATE_PAID,*/
  --PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE) CTEB_DATE_PAID, --'' "วันที่ชำระ",
  PEP_PKG.CONVERT_CURRENCY_TH(CHQE.CHQE_AMOUNT) CTEB_CHQE_AMOUNT
  FROM TSCM_ACCOUNT_LINK ACLK
  INNER JOIN TSCM_ACCOUNT_TRANSACTION ACTR ON ACTR.ACTR_ACCOUNT_ID = ACLK.ACLK_ID
  INNER JOIN TSCM_TRANSACTION_EVENT TREV ON TREV.TREV_ID = ACTR.ACTR_TRANSACTION_EVENT_ID
  INNER JOIN TSCM_TRANSACTION_TYPE TTYP ON TTYP.TTYP_ID = TREV.TREV_TRANSACTION_TYPE_ID
  INNER JOIN TSCM_CLIENT_TRANS_EVENT_BRIDGE CTEB ON CTEB.CTEB_TRANSACTION_EVENT_ID = TREV.TREV_ID
  INNER JOIN TSCM_CLIENT CLNT ON CLNT.CLNT_ID = CTEB.CTEB_CLIENT_ID
  --LEFT JOIN tscm_application APPL ON NVL(APPL.APPL_MTS_ROW_ID,APPL.APPL_CHEQUE_ID)  = NVL(CTEB.CTEB_MTS_ROW_ID,CTEB.CTEB_CHEQUE_ID)
  --LEFT JOIN tscm_application APPL ON APPL.APPL_TRANSACTION_EVENT_ID = TREV.TREV_ID
  --LEFT JOIN tscm_receipt RCPT ON RCPT.RCPT_ID = APPL.appl_receipt_id
  LEFT JOIN TSCM_MT_TRANSACTION MTTR ON MTTR_ID = CTEB.CTEB_MTS_ROW_ID
  LEFT JOIN TSCM_MT_BATCH MTRB ON MTRB.MTRB_ID = MTTR.MTTR_BATCH_ID
  LEFT JOIN TSCM_MT_BATCH_TYPE MTBT ON MTBT.MTBT_ID = MTRB.MTRB_BATCH_TYPE_ID
  LEFT JOIN TSCM_CHEQUE CHQE ON CHQE.CHQE_ID = CTEB.CTEB_CHEQUE_ID
  LEFT JOIN TSCM_CHEQUE_BATCH CQBT ON CQBT.CQBT_ID = CHQE.CHQE_CHEQUE_BATCH_ID
  LEFT JOIN TSCM_CODE PAYMENT_CODE ON PAYMENT_CODE.CODE_ID = CTEB.CTEB_PAYMT_METHOD_CODE_ID
  LEFT JOIN TSCM_CODE CHQE_CODE ON CHQE_CODE.CODE_ID = CHQE.CHQE_STATUS_CODE_ID
  LEFT JOIN TSCM_CODE CHQESTS_CODE ON CHQESTS_CODE.CODE_ID = CHQE.CHQE_EXT_STATUS_CODE_ID
  LEFT JOIN TSCM_CODE MTTR_CODE ON MTTR_CODE.CODE_ID = MTTR.MTTR_TRANS_STATUS_CODE_ID
  LEFT JOIN TSCM_CODE PRINT_CODE ON PRINT_CODE.CODE_ID = CTEB.CTEB_CHEQUE_PRINTER_CODE_ID
  --LEFT JOIN TSCM_CODE APPL_CODE ON APPL_CODE.CODE_ID = APPL.APPL_STATUS_CODE_ID
  --LEFT JOIN TSCM_PHRASE_TRANSLATION TSPT ON TSPT.TSPT_PHRASE = APPL_CODE.CODE_SHORT_DESCRIPTION
  WHERE ACLK.ACLK_ID = P_ACLK_ID AND TREV.TREV_ID = P_TREV_ID
    AND CTEB.CTEB_PAYMENT_IND = -1
    AND CTEB.CTEB_PAYMT_METHOD_CODE_ID IS NOT NULL


  UNION ALL

  SELECT distinct
  appl.appl_id,
  CASE
    WHEN trim(CLNT.CLNT_MAILING_NAME) IS NOT NULL THEN CLNT.CLNT_MAILING_NAME
    ELSE CLNT.CLNT_SURNAME
  END CTEB_CLNT_MAILING_NAME,
  /*CASE WHEN RCPT.RCPT_ID IS NOT NULL THEN PEP_PKG.CONVERT_CURRENCY_TH(APPL.APPL_AMOUNT) || 'A'
       ELSE PEP_PKG.CONVERT_CURRENCY_TH(CTEB.CTEB_AMOUNT) || 'B'
  END CTEB_AMOUNT,*/
  --PEP_PKG.CONVERT_CURRENCY_TH(APPL.APPL_AMOUNT) APPL_AMOUNT,
  --PEP_PKG.CONVERT_CURRENCY_TH(appl.appl_amount) CTEB_AMOUNT,
  CASE WHEN appl.appl_id IS NOT NULL THEN PEP_PKG.CONVERT_CURRENCY_TH(APPL.APPL_AMOUNT)
       ELSE PEP_PKG.CONVERT_CURRENCY_TH(CTEB.CTEB_AMOUNT)
  END CTEB_AMOUNT,
  CTEB.CTEB_PERCENTAGE,
  PAYMENT_CODE.CODE_SHORT_DESCRIPTION CTEB_PAYMT_METHOD_CODE_ID,
  CASE
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Company cheque' THEN cteb.cteb_cheque_payee_name
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Direct Debit' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Credit card' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Direct credit' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Bank draft' THEN cteb.cteb_cheque_payee_name
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Cheque payment' THEN cteb.cteb_bank_account
       WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION = 'Salary deduction' THEN cteb.cteb_bank_account
       ELSE PAYMENT_CODE.CODE_SHORT_DESCRIPTION
  END CTEB_DESCRIPTION,
  --MTRB.MTRB_BATCH_NUMBER CTEB_NUMBER,
/*  CASE
    WHEN CHQE.CHQE_ID IS NOT NULL THEN TO_CHAR(CHQE.CHQE_EXT_CHQ_NUMBER)
    WHEN MTRB.MTRB_ID IS NOT NULL THEN TO_CHAR(MTRB.MTRB_BATCH_NUMBER)
  END CTEB_NUMBER,*/
  CASE
    WHEN cteb_payment_ind = 1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION IN ('Direct credit','Direct Debit','Credit card','Direct debit payment','Credit card payment') THEN TO_CHAR(MTRB.MTRB_BATCH_NUMBER)
        ELSE TO_CHAR(RCPT.RCPT_RECEIPT_NUMBER)
      END
    WHEN cteb_payment_ind = -1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN TO_CHAR(CHQE.CHQE_CHEQUE_NUMBER)
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit payment','Cash payment') THEN TO_CHAR(mtrb.mtrb_batch_number)
      END
  END CTEB_NUMBER,
  CTEB.CTEB_PAYMENT_IND,
  CHQE.CHQE_EXT_CHQ_NUMBER CTEB_CHQE_EXT_CHQ_NUMBER,
  CHQESTS_CODE.CODE_SHORT_DESCRIPTION CTEB_CHQE_EXT_STATUS_CODE_ID, -- สถานะเช็ค
  --CHQE_CODE.CODE_SHORT_DESCRIPTION CTEB_CHQE_STATUS_CODE_ID,--สถานะ
  --MTTRN_CODE.CODE_SHORT_DESCRIPTION CTEB_CHQE_STATUS_CODE_ID,--สถานะ
  /*CASE
    WHEN CHQE.CHQE_ID IS NOT NULL THEN CHQE_CODE.CODE_SHORT_DESCRIPTION
    WHEN MTTR.MTTR_ID IS NOT NULL THEN MTTRN_CODE.CODE_SHORT_DESCRIPTION
  END CTEB_CHQE_STATUS_CODE_ID,*/
  CASE
    WHEN CTEB.CTEB_PAYMENT_IND = 1 THEN
      CASE
        WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Paymt Into Susp' THEN
          CASE
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Credit card','Direct Debit') THEN MTTR_CODE.CODE_SHORT_DESCRIPTION
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Cash payment') THEN NVL(TSPT.TSPT_TRANSLATION,APPL_CODE.CODE_SHORT_DESCRIPTION)
          END
        ELSE --WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Prem From Susp' THEN EIDT
          CASE
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Cash payment') THEN NVL(TSPT.TSPT_TRANSLATION,APPL_CODE.CODE_SHORT_DESCRIPTION)
          END
      END
    WHEN CTEB.CTEB_PAYMENT_IND = -1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN MTTR_CODE.CODE_SHORT_DESCRIPTION
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN CHQE_CODE.CODE_SHORT_DESCRIPTION
      END
  END CTEB_CHQE_STATUS_CODE_ID,
  PRINT_CODE.CODE_SHORT_DESCRIPTION CTEB_CHEQUE_PRINTER_CODE_ID, --'' "สถานที่พิ",
  CASE
    WHEN CTEB.CTEB_PAYMENT_IND = 1 THEN
      CASE
        WHEN TTYP.TTYP_SHORT_DESCRIPTION = 'Paymt Into Susp' THEN
          CASE
            WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTRB.MTRB_DATE_AUTHORISED)-- PEP_PKG.CONVERT_DATE(MTRB.MTRB_DATE_AUTHORISED)
          END
      END
    WHEN CTEB.CTEB_PAYMENT_IND = -1 THEN
      CASE
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN PEP_PKG.CONVERT_DATE(CHQE.CHQE_GP_UPLOAD_DATE)
        WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
      END
  END CTEB_DATE_PAID,
/*  CASE
    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Bank draft','Cheque','Company cheque','Cheque payment') THEN PEP_PKG.CONVERT_DATE(CHQE.CHQE_GP_UPLOAD_DATE)
    WHEN PAYMENT_CODE.CODE_SHORT_DESCRIPTION in ('Direct credit','Credit card','Direct Debit') THEN PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE)
  END CTEB_DATE_PAID,*/
  --PEP_PKG.CONVERT_DATE(MTTR.MTTR_DUE_DATE) CTEB_DATE_PAID, --'' "วันที่ชำระ",
  PEP_PKG.CONVERT_CURRENCY_TH(CHQE.CHQE_AMOUNT) CTEB_CHQE_AMOUNT
  FROM TSCM_ACCOUNT_LINK ACLK
  INNER JOIN TSCM_ACCOUNT_TRANSACTION ACTR ON ACTR.ACTR_ACCOUNT_ID = ACLK.ACLK_ID
  INNER JOIN TSCM_TRANSACTION_EVENT TREV ON TREV.TREV_ID = ACTR.ACTR_TRANSACTION_EVENT_ID
  INNER JOIN TSCM_TRANSACTION_TYPE TTYP ON TTYP.TTYP_ID = TREV.TREV_TRANSACTION_TYPE_ID
  INNER JOIN TSCM_CLIENT_TRANS_EVENT_BRIDGE CTEB ON CTEB.CTEB_TRANSACTION_EVENT_ID = TREV.TREV_ID
  INNER JOIN TSCM_CLIENT CLNT ON CLNT.CLNT_ID = CTEB.CTEB_CLIENT_ID
  --LEFT JOIN tscm_application APPL ON NVL(APPL.APPL_MTS_ROW_ID,APPL.APPL_CHEQUE_ID)  = NVL(CTEB.CTEB_MTS_ROW_ID,CTEB.CTEB_CHEQUE_ID)
  LEFT JOIN tscm_application APPL ON APPL.APPL_TRANSACTION_EVENT_ID = TREV.TREV_ID
  LEFT JOIN tscm_receipt RCPT ON RCPT.RCPT_ID = APPL.appl_receipt_id
  LEFT JOIN TSCM_MT_TRANSACTION MTTR ON MTTR_ID = CTEB.CTEB_MTS_ROW_ID
  LEFT JOIN TSCM_MT_BATCH MTRB ON MTRB.MTRB_ID = MTTR.MTTR_BATCH_ID
  LEFT JOIN TSCM_MT_BATCH_TYPE MTBT ON MTBT.MTBT_ID = MTRB.MTRB_BATCH_TYPE_ID
  LEFT JOIN TSCM_CHEQUE CHQE ON CHQE.CHQE_ID = CTEB.CTEB_CHEQUE_ID
  LEFT JOIN TSCM_CHEQUE_BATCH CQBT ON CQBT.CQBT_ID = CHQE.CHQE_CHEQUE_BATCH_ID
  LEFT JOIN TSCM_CODE PAYMENT_CODE ON PAYMENT_CODE.CODE_ID = CTEB.CTEB_PAYMT_METHOD_CODE_ID
  LEFT JOIN TSCM_CODE CHQE_CODE ON CHQE_CODE.CODE_ID = CHQE.CHQE_STATUS_CODE_ID
  LEFT JOIN TSCM_CODE CHQESTS_CODE ON CHQESTS_CODE.CODE_ID = CHQE.CHQE_EXT_STATUS_CODE_ID
  LEFT JOIN TSCM_CODE MTTR_CODE ON MTTR_CODE.CODE_ID = MTTR.MTTR_TRANS_STATUS_CODE_ID
  LEFT JOIN TSCM_CODE PRINT_CODE ON PRINT_CODE.CODE_ID = CTEB.CTEB_CHEQUE_PRINTER_CODE_ID
  LEFT JOIN TSCM_CODE APPL_CODE ON APPL_CODE.CODE_ID = APPL.APPL_STATUS_CODE_ID
  LEFT JOIN TSCM_PHRASE_TRANSLATION TSPT ON TSPT.TSPT_PHRASE = APPL_CODE.CODE_SHORT_DESCRIPTION
  WHERE ACLK.ACLK_ID = P_ACLK_ID AND TREV.TREV_ID = P_TREV_ID
    AND CTEB.CTEB_PAYMENT_IND = 1
    AND CTEB.CTEB_PAYMT_METHOD_CODE_ID IS NOT NULL
);
END;
